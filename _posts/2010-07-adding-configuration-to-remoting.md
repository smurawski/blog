---
layout: post
title: "Adding Configuration To Remoting"
date: 2010-07-16 08:25
author: steven.murawski@gmail.com
comments: true
categories: [PowerShell, PowerShell Version 2, Tip]
tags: []
---


This is a pretty brief post that will need some further elaboration, but Twitter doesn’t provide the best mechanism for longer examples.



There are two places where you can configure your remote sessions.. 



1) On the remote server – which is covered in a number of places and probably the most discoverable place to put configuration information..&#160; See the help for <a href="http://technet.microsoft.com/en-us/library/dd819508.aspx" target="_blank">about_Session_Configurations</a>.



2) Locally, when you start the PSSession.&#160; This is where we will dig deeper.



&#160;



One of the cool, lesser covered features in remoting is the ability to persist a remote connection to a module.&#160; After you establish a PSSession, you can use <a href="http://technet.microsoft.com/en-us/library/dd347679.aspx" target="_blank">Export-PSSession</a> to create a module that will hold the commands to create the proxies for the commands in that session, as well as the plumbing to recreate that session.



<a href="http://technet.microsoft.com/en-us/library/dd347679.aspx" target="_blank">Export-PSSession</a> will create a script module, which you can modify to work how you would like..&#160; 



In the module, one of the functions generated is the Get-PSImplicitRemotingSession function.&#160; When you call one of the commands from the imported session, it will get the saved PSSession.&#160; If the session has not been established yet, the Set-PsImplicitRemotingSession function will be called, creating the session.&#160; You can add your any commands you would like after that.. 



For example I’m using Invoke-Command below to import a module once the session is connected.&#160; That script block can be anything you need to do to configure your remote session. (NOTE: The Set-PSImplicitRemotingSession is generated by the command, I’m only adding code after that and using the $script:PSSession object that is created.



<span style="color: #0000ff">Set-PSImplicitRemotingSession</span> <span style="color: #000000">`</span>            <span style="color: #000080">-CreatedByModule</span> <span style="color: #ff4500">$true</span> <span style="color: #000000">`
</span>            <span style="color: #000080">-PSSession</span> <span style="color: #000000">(</span>             
            <span style="color: #000000">$(</span>             
                <span style="color: #a9a9a9">&amp;</span> <span style="color: #ff4500">$script:NewPSSession</span> <span style="color: #000000">`
</span>                    <span style="color: #000080">-ComputerName</span> <span style="color: #8b0000">'192.168.16.150'</span> <span style="color: #000000">`
</span>                    <span style="color: #000080">-ApplicationName</span> <span style="color: #8b0000">'/wsman'</span>    <span style="color: #000080">-ConfigurationName</span> <span style="color: #8b0000">'Microsoft.PowerShell'</span> <span style="color: #000000">`
</span>                    <span style="color: #000080">-SessionOption</span> <span style="color: #000000">(</span><span style="color: #0000ff">Get-PSImplicitRemotingSessionOption</span><span style="color: #000000">)</span> <span style="color: #000000">`
</span>                    <span style="color: #000080">-Credential</span> <span style="color: #000000">(</span> <span style="color: #ff4500">$host</span><span style="color: #a9a9a9">.</span><span style="color: #000000">UI</span><span style="color: #a9a9a9">.</span><span style="color: #000000">PromptForCredential</span><span style="color: #000000">(</span> <span style="color: #8b0000">'Windows PowerShell Credential Request'</span><span style="color: #a9a9a9">,</span> <span style="color: #8b0000">'Enter your credentials for http://192.168.16.150/wsman.'</span><span style="color: #a9a9a9">,</span> <span style="color: #8b0000">'phoenix\steve.murawski'</span><span style="color: #a9a9a9">,</span> <span style="color: #8b0000">'192.168.16.150'</span> <span style="color: #000000">)</span> <span style="color: #000000">)</span> <span style="color: #000000">`
</span>                     <span style="color: #000000">`
</span>                    <span style="color: #000080">-Authentication</span> <span style="color: #8a2be2">Default</span> <span style="color: #000000">`
</span>                   <span style="color: #000000">`
</span>            <span style="color: #000000">)</span>             
            <span style="color: #000000">)</span>            

          <span style="color: #0000ff">Invoke-Command</span> <span style="color: #000000">{</span><span style="color: #0000ff">Import-Module</span> <span style="color: #8a2be2">TaskScheduler</span><span style="color: #000000">}</span> <span style="color: #000080">-Session</span> <span style="color: #ff4500">$script:PSSession</span>

